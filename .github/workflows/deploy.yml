name: ðŸš€ Deploy to Production

on:
  workflow_run:
    workflows: ["Fresh 2 CI/CD Pipeline"]
    types:
      - completed
    branches: [main]

  # Manual deployment trigger
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  DENO_VERSION: v2.x

jobs:
  deploy:
    name: ðŸš€ Deploy Application
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¦• Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ðŸ“¦ Download deployment artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-ready-${{ github.sha }}
          path: ./

      - name: ðŸ”§ Prepare deployment
        run: |
          echo "ðŸ”§ Preparing deployment..."
          echo "Target environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Deployment time: $(date)"

      # Example deployment to Deno Deploy
      - name: ðŸŒ Deploy to Deno Deploy
        if: github.event.inputs.environment == 'production' || github.event.inputs.environment == ''
        uses: denoland/deployctl@v1
        with:
          project: "sams-ai-fresh2"
          entrypoint: "main.ts"
          root: "."
        env:
          DENO_DEPLOY_TOKEN: ${{ secrets.DENO_DEPLOY_TOKEN }}

      # Alternative: Deploy to other platforms
      # - name: ðŸ“¤ Deploy to Railway/Fly.io/etc
      #   run: |
      #     echo "Deploying to custom platform..."
      #     # Add your deployment commands here

      - name: âœ… Deployment success
        id: deploy
        run: |
          echo "url=https://sams-ai-fresh2.deno.dev" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://sams-ai-fresh2.deno.dev" >> $GITHUB_STEP_SUMMARY

  post-deploy:
    name: ðŸ” Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: ðŸ¥ Health check
        run: |
          echo "ðŸ¥ Running post-deployment health checks..."

          # Wait a moment for deployment to propagate
          sleep 30

          # Health check
          curl -f https://sams-ai-fresh2.deno.dev/ || exit 1

          echo "âœ… Health check passed!"

      - name: ðŸ§ª Smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."

          # Test key endpoints
          endpoints=(
            "/"
            "/login"
            "/signup"
          )

          for endpoint in "${endpoints[@]}"; do
            echo "Testing $endpoint..."
            status=$(curl -s -o /dev/null -w "%{http_code}" "https://sams-ai-fresh2.deno.dev$endpoint")
            if [ "$status" -eq 200 ]; then
              echo "âœ… $endpoint: OK ($status)"
            else
              echo "âŒ $endpoint: FAILED ($status)"
              exit 1
            fi
          done

          echo "ðŸŽ‰ All smoke tests passed!"

      - name: ðŸ“Š Performance check
        continue-on-error: true
        run: |
          echo "ðŸ“Š Running performance checks..."

          # Simple response time check
          time curl -s https://sams-ai-fresh2.deno.dev/ > /dev/null

          echo "Performance check completed"

      - name: ðŸ“¢ Notify deployment success
        run: |
          echo "ðŸš€ Deployment notification" >> $GITHUB_STEP_SUMMARY
          echo "=========================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live URL**: https://sams-ai-fresh2.deno.dev" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Health Status**: Healthy" >> $GITHUB_STEP_SUMMARY
          echo "âš¡ **Performance**: Good" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor application logs" >> $GITHUB_STEP_SUMMARY
          echo "- Verify user authentication flows" >> $GITHUB_STEP_SUMMARY
          echo "- Check database connectivity" >> $GITHUB_STEP_SUMMARY
